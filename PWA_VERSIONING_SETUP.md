# PWA and Relative Versioning Setup

This document describes the PWA (Progressive Web App) and relative versioning setup, matching the reference repository configuration.

## âœ… PWA Setup

### Features Implemented

1. **VitePWA Plugin Configuration**
   - Located in `frontend/vite.config.ts`
   - Auto-update service worker registration
   - Web App Manifest with icons and theme colors
   - Workbox configuration for caching strategies
   - Runtime caching for API calls and images

2. **Service Worker**
   - Automatically generated by VitePWA plugin
   - Offline support with cache-first and network-first strategies
   - Automatic cleanup of outdated caches
   - Skip waiting and claim clients for immediate updates

3. **Web App Manifest**
   - App name: "Split Money"
   - Short name: "SplitMoney"
   - Theme color: #6200EE (Material Design Purple)
   - Display mode: standalone
   - Icons: 192x192 and 512x512 PNG (to be added)

4. **PWA Meta Tags**
   - Added to `frontend/index.html`
   - Apple mobile web app support
   - Theme color and status bar style
   - Security headers (CSP, X-Frame-Options, etc.)

## âœ… Relative Versioning Setup

### Version Management

1. **Version Sources (Priority Order)**
   - `package.json` (root) - Primary source of truth
   - `frontend/package.json` - Synced with root
   - `app/build.gradle` - Android versionName
   - `VERSION.txt` - Fallback

2. **Version Files Updated on Bump**
   - `package.json` (root)
   - `frontend/package.json`
   - `app/build.gradle` (versionName)
   - `app/build.gradle.kts` (if exists)
   - `frontend/public/version.json` - For PWA relative versioning
   - `VERSION.txt`

3. **Relative Versioning Endpoints**

   **Runtime Version Endpoint** (`/api/version`)
   - Served dynamically by Vite dev server middleware
   - Reads fresh from `package.json` on every request
   - No caching headers to ensure latest version
   - Returns: `{ "version": "1.0.0" }`

   **Static Version File** (`/version.json`)
   - Located in `frontend/public/version.json`
   - Updated during build process
   - Accessible at runtime via `/version.json`
   - Used for production builds

4. **Version Injection**

   **HTML Meta Tag**
   - Injected into `<head>` during build
   - Format: `<meta name="app-version" content="1.0.0" />`
   - Accessible via `document.querySelector('meta[name="app-version"]')`

   **Build-time Constant**
   - `__APP_VERSION__` injected via Vite `define`
   - Available in TypeScript/JavaScript code
   - Type definitions in `frontend/src/vite-env.d.ts`

5. **Bundle Size Analysis**
   - Automatically analyzes build output
   - Generates `frontend/public/bundle-info.json`
   - Includes chunk sizes, total size, and chunk count
   - Logged during build process

## ðŸ“‹ Version Management Scripts

### Available Commands

```bash
# Bump version (patch/minor/major)
npm run version:patch   # 1.0.0 -> 1.0.1
npm run version:minor   # 1.0.0 -> 1.1.0
npm run version:major   # 1.0.0 -> 2.0.0

# Set specific version
npm run version:set 1.2.3
```

### What Gets Updated

When version is bumped, the following files are automatically updated:
- âœ… Root `package.json`
- âœ… `frontend/package.json`
- âœ… `app/build.gradle` (versionName)
- âœ… `app/build.gradle.kts` (if exists)
- âœ… `frontend/public/version.json`
- âœ… `VERSION.txt`

## ðŸ”§ Usage in Code

### Frontend (TypeScript/React)

```typescript
// Access build-time version constant
const appVersion = __APP_VERSION__;

// Fetch runtime version from API
const response = await fetch('/api/version');
const { version } = await response.json();

// Or read from static file
const response = await fetch('/version.json');
const { version } = await response.json();
```

### Android (Kotlin)

```kotlin
// Read from BuildConfig (after syncing Gradle)
val versionName = BuildConfig.VERSION_NAME
```

## ðŸš€ Build Process

### Frontend Build

1. **Pre-build**: Version is read from root `package.json`
2. **Build Start**: `version.json` is updated in `public/` folder
3. **HTML Transform**: Version meta tag is injected
4. **Build Complete**: Bundle size analysis runs
5. **Post-build**: `bundle-info.json` is generated

### Version Sync

The version is kept in sync across:
- Root package.json (source of truth)
- Frontend package.json
- Android build.gradle
- Frontend public/version.json
- VERSION.txt

## ðŸ“ Pre-commit Hooks

The pre-commit hooks automatically:
- âœ… Validate version bump (branch version > main version)
- âœ… Run frontend linting (ESLint)
- âœ… Run frontend type checking (TypeScript)
- âœ… Run frontend build validation
- âœ… Run Android linting (ktlint)
- âœ… Run Android type checking (Kotlin)
- âœ… Run Android build validation
- âœ… Auto-add `frontend/public/version.json` if modified

## ðŸ”„ GitHub Actions

### PR Checks Workflow

Includes checks for:
- Frontend ESLint validation
- Frontend TypeScript compilation
- Frontend build validation
- Android lint validation
- Android Kotlin compilation
- Android build validation
- Test suite execution
- Version bump validation

### Version Bump Workflow

Automatically:
- Bumps version on merge to main
- Updates all version files
- Commits version bump
- Creates git tag
- Creates GitHub release

### Deploy Workflow

- Builds frontend PWA
- Deploys to GitHub Pages
- Triggers Lighthouse CI

## ðŸŽ¯ Key Features

1. **Single Source of Truth**: Root `package.json` is the primary version source
2. **Automatic Sync**: All version files are kept in sync automatically
3. **Runtime Access**: Version accessible via `/api/version` endpoint
4. **Build-time Access**: Version available as `__APP_VERSION__` constant
5. **PWA Support**: Version included in PWA manifest and meta tags
6. **Bundle Analysis**: Automatic bundle size tracking

## ðŸ“š Reference

This setup matches the reference repository:
- Repository: `git@github.com:adityaarakal/instant-express-manager.git`
- Same PWA configuration
- Same relative versioning approach
- Same version management scripts
- Same build process

