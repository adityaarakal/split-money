name: PR Quality Checks

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  pull-requests: write

jobs:
  quality-checks:
    name: Code Quality Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Node.js (for version scripts)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: Install dependencies
        run: |
          # Install root workspace dependencies
          npm install
          # Install frontend workspace dependencies explicitly to ensure optional deps
          cd frontend
          npm install
          cd ..
          # Grant execute permission to gradlew
          chmod +x ./gradlew || true
      
      # ============================================================================
      # STEP 1: LINTING VALIDATION
      # ============================================================================
      - name: ğŸ“‹ Step 1/5 - Linting Validation
        run: |
          echo "ğŸš¨ STRICT COMPLIANCE CHECK - ZERO TOLERANCE POLICY"
          echo "âš ï¸  NO BYPASSING METHODS ALLOWED - ALL CHECKS MUST PASS"
          echo ""
          echo "ğŸ“‹ Step 1/5: Linting Validation"
          
          # Frontend linting
          if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
            echo "Running ESLint validation for frontend (excluding test files)..."
            cd frontend
            npx eslint 'src/**/*.{ts,tsx}' --ignore-pattern '**/__tests__/**' --ignore-pattern '**/*.test.ts' --ignore-pattern '**/*.test.tsx' --report-unused-disable-directives --max-warnings 3
            if [ $? -ne 0 ]; then
              echo "âŒ CRITICAL: ESLint errors or warnings found in frontend production code."
              echo "âŒ ALL production code errors must be fixed before merge."
              echo "ğŸ”’ ENFORCEMENT: PR blocked - Fix production code errors first"
              echo "ğŸ“‹ REQUIRED: Run 'cd frontend && npm run lint' and fix ALL production code errors/warnings"
              cd ..
              exit 1
            fi
            cd ..
            echo "âœ… Frontend linting validation passed!"
          fi
          
          # Android linting
          if [ -f "gradlew" ]; then
            echo "Running Android lint validation..."
            ./gradlew ktlintCheck --no-daemon || ./gradlew lint --no-daemon || echo "âš ï¸  Lint check skipped - gradle wrapper not configured"
            if [ $? -ne 0 ]; then
              echo "âŒ CRITICAL: Android lint errors or warnings found in production code."
              echo "âŒ ALL production code errors must be fixed before merge."
              echo "ğŸ”’ ENFORCEMENT: PR blocked - Fix production code errors first"
              echo "ğŸ“‹ REQUIRED: Run './gradlew ktlintCheck' or './gradlew lint' and fix ALL production code errors/warnings"
              exit 1
            fi
            echo "âœ… Android linting validation passed!"
          fi
          
          echo "âœ… Production code linting validation passed!"
      
      # ============================================================================
      # STEP 2: TYPE CHECKING
      # ============================================================================
      - name: ğŸ“‹ Step 2/5 - Type Checking
        run: |
          echo ""
          echo "ğŸ“‹ Step 2/5: Type Checking"
          
          # Frontend TypeScript checking
          if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
            echo "Running TypeScript compilation check for frontend..."
            cd frontend
            npx tsc --noEmit
            if [ $? -ne 0 ]; then
              echo "âŒ CRITICAL: TypeScript compilation errors found."
              echo "âŒ ALL TypeScript errors must be fixed before merge."
              echo "ğŸ”’ ENFORCEMENT: PR blocked - Fix TypeScript errors first"
              echo "ğŸ“‹ REQUIRED: Fix ALL TypeScript compilation errors"
              cd ..
              exit 1
            fi
            cd ..
            echo "âœ… Frontend type checking passed!"
          fi
          
          # Android Kotlin checking
          if [ -f "gradlew" ]; then
            echo "Running Kotlin compilation check for Android..."
            ./gradlew compileDebugKotlin --no-daemon || ./gradlew compileKotlin --no-daemon
            if [ $? -ne 0 ]; then
              echo "âŒ CRITICAL: Kotlin compilation errors found."
              echo "âŒ ALL Kotlin errors must be fixed before merge."
              echo "ğŸ”’ ENFORCEMENT: PR blocked - Fix Kotlin errors first"
              echo "ğŸ“‹ REQUIRED: Fix ALL Kotlin compilation errors"
              exit 1
            fi
            echo "âœ… Android type checking passed!"
          fi
          
          echo "âœ… Type checking passed!"
      
      # ============================================================================
      # STEP 3: BUILD VALIDATION
      # ============================================================================
      - name: ğŸ“‹ Step 3/5 - Build Validation
        run: |
          echo ""
          echo "ğŸ“‹ Step 3/5: Build Validation"
          
          # Frontend build validation
          if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
            echo "Running frontend build validation..."
            cd frontend
            npm run build
            if [ $? -ne 0 ]; then
              echo "âŒ CRITICAL: Frontend build validation failed."
              echo "âŒ Production build must succeed - no build errors allowed"
              echo "ğŸ”’ ENFORCEMENT: PR blocked - Fix build errors first"
              echo "ğŸ“‹ REQUIRED: Run 'cd frontend && npm run build' and fix ALL build errors"
              cd ..
              exit 1
            fi
            cd ..
            echo "âœ… Frontend build validation passed!"
          fi
          
          # Android build validation
          if [ -f "gradlew" ]; then
            echo "Running Android build validation..."
            ./gradlew assembleDebug --no-daemon || ./gradlew build --no-daemon
            if [ $? -ne 0 ]; then
              echo "âŒ CRITICAL: Android build validation failed."
              echo "âŒ Production build must succeed - no build errors allowed"
              echo "ğŸ”’ ENFORCEMENT: PR blocked - Fix build errors first"
              echo "ğŸ“‹ REQUIRED: Run './gradlew assembleDebug' and fix ALL build errors"
              exit 1
            fi
            echo "âœ… Android build validation passed!"
          fi
          
          echo "âœ… Build validation passed!"
      
      # ============================================================================
      # STEP 4: MANDATORY TEST SUITE (TDD APPROACH)
      # ============================================================================
      - name: ğŸ“‹ Step 4/5 - Mandatory Test Suite (TDD Approach)
        run: |
          echo ""
          echo "ğŸ“‹ Step 3/5: Mandatory Test Suite (TDD Approach)"
          echo "ğŸš¨ TDD RULE: Locked tests are DELIVERED features (immutable)"
          echo "ğŸš¨ BYPASS PROHIBITED: This check cannot be skipped or bypassed"
          echo "ğŸš¨ AI AGENTS: You cannot bypass this check - tests must pass"
          echo "ğŸ“‹ If tests fail â†’ Fix IMPLEMENTATION, NOT tests"
          echo "ğŸ“‹ REQUIRED: All tests must pass before PR can be merged"
          echo ""
          
          if [ -f "gradlew" ]; then
            ./gradlew test --no-daemon || ./gradlew testDebugUnitTest --no-daemon
            if [ $? -ne 0 ]; then
              echo ""
              echo "âŒ CRITICAL: Test suite failed"
              echo "âŒ All tests must pass before PR can be merged"
              echo ""
              echo "ğŸ”’ ENFORCEMENT: PR blocked - Fix failing tests first"
              echo "ğŸ“‹ TDD RULE: Locked tests are DELIVERED features"
              echo "ğŸ“‹ REQUIRED: Fix your IMPLEMENTATION to make tests pass"
              echo "ğŸ“‹ DO NOT: Modify locked test files"
              echo ""
              echo "âš ï¸  BYPASS PROHIBITED: This check cannot be skipped"
              echo "âš ï¸  Even AI agents cannot bypass this check"
              echo "âš ï¸  PR cannot be merged until tests pass"
              echo "âš ï¸  Tests MUST pass - no exceptions"
              echo ""
              echo "ğŸ’¡ TDD Approach:"
              echo "   â€¢ Tests define what 'working' means"
              echo "   â€¢ Implementation must conform to tests"
              echo "   â€¢ If tests fail â†’ Fix implementation, NOT tests"
              echo ""
              echo "ğŸš¨ MANDATORY: This check CANNOT BE BYPASSED - All tests must pass"
              exit 1
            fi
            echo "âœ… Test suite passed!"
          else
            echo "âš ï¸  Gradle wrapper not found - skipping test check"
          fi
      
      # ============================================================================
      # STEP 5: MANDATORY VERSION BUMP VALIDATION
      # ============================================================================
      - name: ğŸ“‹ Step 5/5 - Mandatory Version Bump Validation
        run: |
          echo ""
          echo "ğŸ“‹ Step 4/5: Mandatory Version Bump Validation"
          echo "ğŸš¨ MANDATORY CHECK: PR cannot be merged without version bump"
          echo "ğŸ“‹ REQUIRED: Incoming branch version must be ahead of base branch version"
          echo ""
          bash scripts/validate-version-bump.sh
          if [ $? -ne 0 ]; then
            echo "âŒ CRITICAL: Version bump validation failed"
            echo "âŒ ENFORCEMENT: PR blocked - Version bump is MANDATORY"
            echo "ğŸ“‹ REQUIRED: Incoming branch version must be ahead of base branch version"
            echo "âš ï¸  This check CANNOT BE BYPASSED - All PRs must have version bump"
            exit 1
          fi
          echo "âœ… Version bump validation passed!"
      
      # ============================================================================
      # SUCCESS - ALL CHECKS PASSED
      # ============================================================================
      - name: âœ… All Quality Checks Passed
        run: |
          echo ""
          echo "ğŸ‰ ALL PR QUALITY CHECKS PASSED!"
          echo "âœ… Your code meets ALL quality standards"
          echo "âœ… Ready to merge!"
          echo ""
          echo "ğŸ”’ ENFORCEMENT STATUS: COMPLIANT"
          echo "ğŸ“‹ POLICY: ZERO TOLERANCE - NO BYPASSING ALLOWED"
          echo "âœ… RESULT: PR approved - All standards met"
      
      # ============================================================================
      # COMMENT ON PR (Optional - adds a comment when checks pass/fail)
      # ============================================================================
      - name: Comment PR on Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **All Quality Checks Passed!**\n\n- âœ… ESLint validation passed (frontend production code only)\n- âœ… TypeScript type checking passed\n- âœ… Build validation passed\n- âœ… **Mandatory test suite passed**\n- âœ… Mandatory version bump validation passed\n\nYour PR is ready for review! ğŸ‰'
            })
      
      - name: Comment PR on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Quality Checks Failed**\n\nPlease fix the following issues:\n- ESLint errors/warnings in frontend production code\n- TypeScript compilation errors\n- Build validation errors\n- **Mandatory test suite** (all tests must pass)\n- **Mandatory version bump validation** (incoming branch version must be ahead of base branch version)\n\nğŸ”’ **ENFORCEMENT**: PR cannot be merged until all checks pass.\n\nğŸ“‹ **REQUIRED**: Fix all errors and push again.'
            })


