name: Version Bump on Merge

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && 
      !contains(github.event.head_commit.message, 'chore: Bump version') &&
      github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Determine Version Bump Type
        id: bump-type
        run: |
          BUMP_TYPE="patch"  # Default to patch
          
          # Check if manually triggered
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BUMP_TYPE="${{ github.event.inputs.bump_type }}"
            echo "Manual bump type: $BUMP_TYPE"
          else
            # Analyze commits in the push
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "Last tag: $LAST_TAG"
            
            # Get commits since last tag (or all commits if no tag)
            # Get the merge commit message (which usually contains the PR description)
            if [ "$LAST_TAG" != "v0.0.0" ]; then
              # Get the merge commit message
              MERGE_COMMIT=$(git log ${LAST_TAG}..HEAD --first-parent --pretty=format:"%s" -1)
              # Also get all non-merge commits in case we need them
              NON_MERGE_COMMITS=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"%s")
              COMMITS="$MERGE_COMMIT"$'\n'"$NON_MERGE_COMMITS"
            else
              # Get the latest merge commit and recent non-merge commits
              MERGE_COMMIT=$(git log --first-parent --pretty=format:"%s" -1)
              NON_MERGE_COMMITS=$(git log --no-merges --pretty=format:"%s" -10)
              COMMITS="$MERGE_COMMIT"$'\n'"$NON_MERGE_COMMITS"
            fi
            
            echo "Analyzing commits:"
            echo "$COMMITS"
            
            # Check for breaking changes
            if echo "$COMMITS" | grep -qiE "(BREAKING CHANGE|!|breaking)"; then
              BUMP_TYPE="major"
              echo "Found breaking change"
            # Check for features (case-insensitive, with or without parentheses)
            elif echo "$COMMITS" | grep -qiE "^(feat|Feat|FEAT)(\(|:)"; then
              BUMP_TYPE="minor"
              echo "Found feature"
            # Check for fixes (case-insensitive, with or without parentheses)
            elif echo "$COMMITS" | grep -qiE "^(fix|Fix|FIX)(\(|:)"; then
              BUMP_TYPE="patch"
              echo "Found fix"
            # Check for documentation updates (case-insensitive, with or without parentheses)
            elif echo "$COMMITS" | grep -qiE "^(docs|Docs|DOCS)(\(|:)"; then
              BUMP_TYPE="patch"
              echo "Found documentation update"
            # Check PR labels from commit message (if merged via PR)
            elif echo "$COMMITS" | grep -qiE "\[major\]|\[breaking\]"; then
              BUMP_TYPE="major"
              echo "Found major label"
            elif echo "$COMMITS" | grep -qiE "\[feature\]|\[enhancement\]|\[minor\]"; then
              BUMP_TYPE="minor"
              echo "Found feature label"
            elif echo "$COMMITS" | grep -qiE "\[bug\]|\[fix\]|\[patch\]"; then
              BUMP_TYPE="patch"
              echo "Found bug label"
            fi
          fi
          
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "Bump type determined: $BUMP_TYPE"
      
      - name: Install dependencies
        run: npm install
      
      - name: Get Current Version
        id: current-version
        run: |
          source scripts/version-utils.sh
          CURRENT_VERSION=$(get_current_version)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
      
      - name: Bump Version
        id: new-version
        run: |
          CURRENT_VERSION="${{ steps.current-version.outputs.current_version }}"
          BUMP_TYPE="${{ steps.bump-type.outputs.bump_type }}"
          
          # Parse version
          IFS='.' read -ra PARTS <<< "$CURRENT_VERSION"
          MAJOR=${PARTS[0]}
          MINOR=${PARTS[1]}
          PATCH=${PARTS[2]}
          
          # Bump version
          case "$BUMP_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"
          
          # Update version using version-utils.sh
          source scripts/version-utils.sh
          set_version "$NEW_VERSION"
      
      - name: Generate Changelog Entry
        id: changelog
        run: |
          NEW_VERSION="${{ steps.new-version.outputs.new_version }}"
          CURRENT_VERSION="${{ steps.current-version.outputs.current_version }}"
          
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" -20)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)")
          fi
          
          # Categorize commits
          ADDED=$(echo "$COMMITS" | grep -iE "^\- (feat|add)" || true)
          FIXED=$(echo "$COMMITS" | grep -iE "^\- (fix|bug)" || true)
          CHANGED=$(echo "$COMMITS" | grep -iE "^\- (refactor|change|update)" || true)
          DOCS=$(echo "$COMMITS" | grep -iE "^\- (docs)" || true)
          OTHER=$(echo "$COMMITS" | grep -ivE "(feat|add|fix|bug|refactor|change|update|docs)" || true)
          
          CHANGELOG_ENTRY="## [$NEW_VERSION] - $(date +%Y-%m-%d)
"
          
          if [ -n "$ADDED" ]; then
            CHANGELOG_ENTRY+="
### Added
$ADDED
"
          fi
          
          if [ -n "$FIXED" ]; then
            CHANGELOG_ENTRY+="
### Fixed
$FIXED
"
          fi
          
          if [ -n "$CHANGED" ]; then
            CHANGELOG_ENTRY+="
### Changed
$CHANGED
"
          fi
          
          if [ -n "$DOCS" ]; then
            CHANGELOG_ENTRY+="
### Documentation
$DOCS
"
          fi
          
          if [ -n "$OTHER" ]; then
            CHANGELOG_ENTRY+="
### Other
$OTHER
"
          fi
          
          echo "changelog_entry<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_ENTRY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Update CHANGELOG.md
        run: |
          NEW_VERSION="${{ steps.new-version.outputs.new_version }}"
          CHANGELOG_ENTRY="${{ steps.changelog.outputs.changelog_entry }}"
          
          if [ ! -f CHANGELOG.md ]; then
            cat > CHANGELOG.md << 'EOF'
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

EOF
          fi
          
          # Insert changelog entry after the header
          awk -v entry="$CHANGELOG_ENTRY" '
            /^# Changelog/ { print; print ""; print entry; next }
            /^## \[/ && !inserted { print entry; inserted=1 }
            { print }
          ' CHANGELOG.md > CHANGELOG.md.tmp
          mv CHANGELOG.md.tmp CHANGELOG.md
      
      - name: Commit Version Bump
        run: |
          NEW_VERSION="${{ steps.new-version.outputs.new_version }}"
          git add package.json frontend/package.json app/build.gradle app/build.gradle.kts frontend/public/version.json VERSION.txt CHANGELOG.md 2>/dev/null || git add package.json frontend/package.json VERSION.txt CHANGELOG.md
          git commit -m "chore: Bump version to $NEW_VERSION"
          git push
      
      - name: Create Git Tag
        run: |
          NEW_VERSION="${{ steps.new-version.outputs.new_version }}"
          git tag "v$NEW_VERSION"
          git push origin "v$NEW_VERSION"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.new-version.outputs.new_version }}
          name: Release v${{ steps.new-version.outputs.new_version }}
          body: |
            ## Changes in this release
            
            ${{ steps.changelog.outputs.changelog_entry }}
            
            See [CHANGELOG.md](CHANGELOG.md) for full details.
          draft: false
          prerelease: false
          generate_release_notes: true


